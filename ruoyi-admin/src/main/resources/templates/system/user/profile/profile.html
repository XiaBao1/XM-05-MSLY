<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('用户个人信息')" />
    <style type="text/css">.user-info-head{position:relative;display:inline-block;}.user-info-head:hover:after{content:'\f030';position:absolute;left:0;right:0;top:0;bottom:0;color:#eee;background:rgba(0,0,0,0.5);font-family:FontAwesome;font-size:24px;font-style:normal;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;cursor:pointer;line-height:110px;border-radius:50%;}</style>
</head>
<input id="userId" name="userId" type="hidden" th:value="${user.userId}" />

<section class="section-content">
    <div class="container">
        <div class="row">
            <div class="text-center">
                <p class="user-info-head" onclick="avatar()"><img class="img-circle img-lg" th:src="(${#strings.isEmpty(user.avatar)}) ? @{/img/profile.jpg} : @{${user.avatar}}" th:onerror="'this.src=\'' + @{'/img/profile.jpg'} + '\''"></p>
                <p id="xg">点击图片修改头像</a></p>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-3"></div>
            <div class="col-sm-6">
                <h3 align="center" style="padding-top: 10px;padding-bottom: 5px;">个人资料</h3>
            </div>
            <div class="col-sm-3"></div>
        </div>
        <div class="row">
            <div class="col-sm-2"></div>
            <div class="col-sm-8">
                <table class="table table-hover" id="infotable" style="table-layout: fixed;word-wrap:break-word;">
                    <thead style="display: none;">
                        <tr>
                            <th style="width: 30%;">名称</th>
                            <th style="width: 50%;">图标</th>
                            <th style="width: 20%;">内容</th>
                        </tr>
                    </thead>
                    <tr class="text-center">
                        <td colspan='4'>您的账号</td>
                        <td colspan='2'><i class="fa fa-id-card"></i></td>
                        <td colspan='4'>[[${user.loginName}]]</td>
                    </tr>
                    <tr class="text-center">
                        <td colspan='4'>您的姓名</td>
                        <td colspan='2'><i class="fa fa-user"></i></td>
                        <td colspan='4'>[[${user.userName}]]</td>
                    </tr>
                    <tr class="text-center">
                        <td colspan='4'>手机号码</td>
                        <td colspan='2'><i class="fa fa-phone"></i></td>
                        <td colspan='4'>[[${user.phonenumber}]]</td>
                    </tr>
                    <tr class="text-center">
                        <td colspan='4'>邮箱地址</td>
                        <td colspan='2'><i class="fa fa-envelope-o"></i></td>
                        <!--<td colspan='5'>[[${#strings.abbreviate(user.email, 16)}]]</td>-->
                        <td colspan='4'>[[${user.email}]]</td>
                    </tr>
                    <tr class="text-center">
                        <td colspan='4'>您的性别</td>
                        <td colspan='2'><i class="fa fa-heart"></i></td>
                        <td colspan='4'><div id="sex" name="sex"></div></td>
                        <!--<td colspan='4'>[[${user.sex}]]</td>-->
                    </tr>
                    <tr class="text-center">
                        <td colspan='4'>所在省份</td>
                        <td colspan='2'><i class="fa fa-picture-o"></i></td>
                        <td colspan='4'>[[${user.province}]]</td>
                    </tr>
                    <tr class="text-center">
                        <td colspan='4'>账户余额</td>
                        <td colspan='2'><i class="fa fa-jpy"></i></td>
                        <td colspan='4'>[[${user.money}]]</td>
                    </tr>
                    <tr id="cz1">
                        <td align="center" colspan='4'>
                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#updateForm">
                                修改资料
                            </button>
                        </td>
                        <td align="center" colspan='2'>
                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#updatePwdForm">
                                修改密码
                            </button>
                        </td>
                        <td align="center" colspan='4'>
                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#updateMoneyForm">
                                账户充值
                            </button>
                        </td>
                    </tr>
                    <tr id="cz2">
                        <td align="center" colspan='4'>
                            <a class="btn btn-warning" onclick="myExportExcel()">
                                <i class="fa fa-download"></i> 导出信息
                            </a>
                        </td>
                        <td align="center" colspan='2'>
                        </td>
                        <td align="center" colspan='4'>
                            <a class="btn btn-success" onclick="printHtml();">
                                <i class="fa fa-plus"></i> 打印信息
                            </a>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="col-sm-2"></div>
        </div>
    </div>
</section>

<!--update form-->

<div class="modal fade" id="updateForm" tabindex="-1" role="dialog" aria-labelledby="updateForm" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="UpdateFormTitle">修改个人资料</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="input-user-info">
                    <input name="id" id="input-user-account" type="hidden" value="">
                    <label for="input-login-name" class="control-label">您的账号</label>
                    <input type="text" class="form-control" id="input-login-name" name="loginName" placeholder="请输入您的账号名称" value="">
                    <label for="input-user-name" class="control-label">您的姓名</label>
                    <input type="text" class="form-control" id="input-user-name" name="userName" placeholder="请输入您的姓名" value="">
                    <label for="input-user-phone" class="control-label">手机号码</label>
                    <input type="text" class="form-control" id="input-user-phone" name="phonenumber" placeholder="请输入手机号码" value="">
                    <label for="input-user-email" class="control-label">邮箱地址</label>
                    <input type="text" class="form-control" id="input-user-email" name="email" placeholder="请输入邮箱地址" value="">
                    <label for="choose-user-sex" class="control-label">性别</label>
                    <select class="form-control" id="choose-user-sex" name="sex">
                        <option value="0">男</option>
                        <option value="1">女</option>
                        <option value="2">其他</option>
                    </select>
                    <label for="input-user-province" class="control-label">所在省份</label>
                    <input type="text" class="form-control" id="input-user-province" name="province" placeholder="请输入所在省份" value="">

                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消修改</button>
                <button type="button" class="btn btn-primary" onclick="submitUserInfo()" >确认修改</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="updateMoneyForm" tabindex="-1" role="dialog" aria-labelledby="updateForm" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="UpdateMoneyTitle">修改个人资料</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="input-user-money-form">
                    <input name="id" id="input-money-user-account" type="hidden" value="">
                    <label for="input-user-money" class="control-label">充值金额</label>
                    <input type="text" class="form-control" id="input-user-money" name="money" placeholder="请输入充值金额" value="">
                    <label for="input-user-money" class="control-label">支付密码</label>
                    <input type="text" class="form-control" id="input-pay-pwd" name="paypwd" placeholder="请输入支付密码" value="">

                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消充值</button>
                <button type="button" class="btn btn-primary" onclick="submitUserMoney()" >确认充值</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="updatePwdForm" tabindex="-1" role="dialog" aria-labelledby="updatePwdForm" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">修改密码</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="input-user-pwd">
                    <label class="control-label">旧密码：</label>
                    <input type="password" class="form-control" name="oldPassword" placeholder="请输入旧密码">
                    <label class="control-label">新密码：</label>
                    <input type="password" class="form-control" name="newPassword" id="newPassword" placeholder="请输入新密码">
                        <th:block th:with="chrtype=${@config.getKey('sys.account.chrtype')}">
                        <th:block th:if="${chrtype != '0'}">
                        <span class="help-block m-b-none">
                            <th:block th:if="${chrtype == '1'}"><i class="fa fa-info-circle" style="color: red;"></i>  密码只能为0-9数字 </th:block>
                            <th:block th:if="${chrtype == '2'}"><i class="fa fa-info-circle" style="color: red;"></i>  密码只能为a-z和A-Z字母</th:block>
                            <th:block th:if="${chrtype == '3'}"><i class="fa fa-info-circle" style="color: red;"></i>  密码必须包含（字母，数字）</th:block>
                            <th:block th:if="${chrtype == '4'}"><i class="fa fa-info-circle" style="color: red;"></i>  密码必须包含（字母，数字，特殊字符!@#$%^&*()-=_+）</th:block>
                        </span>
                        </th:block>
                        </th:block>
                    <label class="control-label">确认密码：</label>
                    <input type="password" class="form-control" name="confirmPassword" placeholder="请确认密码">
              </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消修改</button>
                <button type="button" class="btn btn-primary" onclick="submitChangPassword()" >确认修改</button>
            </div>
        </div>
    </div>
</div>



<th:block th:include="include :: footer" />
<script>
    /*用户管理-头像*/
    function avatar() {
        var url = ctx + 'system/user/profile/avatar';
        top.layer.open({
            type: 2,
            area: [$(window).width() + 'px', $(window).height() + 'px'],
            fix: false,
            //不固定
            maxmin: true,
            shade: 0.3,
            title: "修改头像",
            content: url,
            btn: ['确定', '关闭'],
            // 弹层外区域关闭
            shadeClose: true,
            yes: function(index, layero) {
                var iframeWin = layero.find('iframe')[0];
                iframeWin.contentWindow.submitHandler(index, layero);
            },
            cancel: function(index) {
                return true;
            }
        });
    }

    /*用户信息-修改*/
    $("#input-user-info").validate({
        onkeyup: false,
        rules:{
            userName:{
                required:true,
            },
            email:{
                required:true,
                email:true,
                remote: {
                    url: ctx + "system/user/checkEmailUnique",
                    type: "post",
                    dataType: "json",
                    data: {
                        "userId": function() {
                            return $("#userId").val();
                        },
                        "email": function() {
                            return $.common.trim($("#input-user-email").val());
                        }
                    },
                    dataFilter: function (data, type) {
                        return $.validate.unique(data);
                    }
                }
            },
            phonenumber:{
                required:true,
                isPhone:true,
                remote: {
                    url: ctx + "system/user/checkPhoneUnique",
                    type: "post",
                    dataType: "json",
                    data: {
                        "userId": function() {
                            return $("#userId").val();
                        },
                        "phonenumber": function() {
                            return $.common.trim($("#input-user-phone").val());
                        }
                    },
                    dataFilter: function (data, type) {
                        return $.validate.unique(data);
                    }
                }
            },
        },

        messages: {
            "userName": {
                required: "请输入用户名称",
            },
            "email": {
                required: "请输入邮箱",
                remote: "Email已经存在"
            },
            "phonenumber":{
                required: "请输入手机号码",
                remote: "手机号码已经存在"
            }
        },
        focusCleanup: true
    });

    /*账户余额-修改*/
    $("#input-user-money-form").validate({
        onkeyup: false,
        rules: {
            money: {
                required: true,
                digits: true,
                number: true,
                min: 0,
                max: 2147483647
            },
            paypwd: {
                required: true
            }
        },
        messages: {
            "money": {
                required: "请充值",
                digits: "只能充值正整数金额",
                number: "只能充值正整数金额",
                max: "为保障您的账户安全，不能充值过大金额"
            },
            "paypwd": {
                required: "请输入支付密码！"
            }
        },
        focusCleanup: true
    });

    function submitUserInfo() {
        if ($.validate.form()) {
            console.log($('#input-user-info').serialize())
            //$.operate.saveModal(ctx + "system/user/profile/update", $('#input-user-info').serialize());
            $.ajax({
                url: ctx + "system/user/profile/update",
                data: $('#input-user-info').serialize(),
                type: "post",
                success: function(result) {
                    if (result.code == web_status.SUCCESS) {
                        layer.msg("请稍后……", {
                            icon: 1,
                            time: 500,
                            shade: [0.1, '#8F8F8F']
                        },function() {
                            location.reload();
                        });
                    } else {
                        alert(result.msg);
                    }
                }
            })
            $('#updateForm').modal('hide');
        }
    }

    function submitUserMoney() {
        if ($.validate.form()) {
            //var cur=$('#input-user-money-form').serialize();
            //$.operate.saveModal(ctx + "system/user/profile/update", $('#input-user-money-form').serialize());
            $.ajax({
                url: ctx + "system/user/profile/update",
                data: $('#input-user-money-form').serialize(),
                type: "post",
                success: function(result) {
                    if (result.code == web_status.SUCCESS) {
                        layer.msg("请稍后……", {
                            icon: 1,
                            time: 500,
                            shade: [0.1, '#8F8F8F']
                        },function() {
                            location.reload();
                        });
                    } else {
                        alert(result.msg);
                    }
                }
            })
            $('#updateMoneyForm').modal('hide');
        }
    }

    /*用户管理-修改密码*/
    $("#form-user-resetPwd").validate({
        onkeyup: false,
        rules:{
            oldPassword:{
                required:true,
                remote: {
                    url: ctx + "system/user/profile/checkPassword",
                    type: "get",
                    dataType: "json",
                    data: {
                        password: function() {
                            return $("input[name='oldPassword']").val();
                        }
                    }
                }
            },
            newPassword: {
                required: true,
                minlength: 6,
                maxlength: 20
            },
            confirmPassword: {
                required: true,
                equalTo: "#newPassword"
            }
        },
        messages: {
            oldPassword: {
                required: "请输入原密码",
                remote: "原密码错误"
            },
            newPassword: {
                required: "请输入新密码",
                minlength: "密码不能小于6个字符",
                maxlength: "密码不能大于20个字符"
            },
            confirmPassword: {
                required: "请再次输入新密码",
                equalTo: "两次密码输入不一致"
            }

        },
        focusCleanup: true
    });

    function submitChangPassword () {
        var chrtype = [[${#strings.defaultString(@config.getKey('sys.account.chrtype'), 0)}]];
        var password = $("#newPassword").val();
        if ($.validate.form("input-user-pwd") && checkpwd(chrtype, password)) {
            //$.operate.saveModal(ctx + "system/user/profile/resetPwd", $('#input-user-pwd').serialize());
            $.ajax({
                url: ctx + "system/user/profile/resetPwd",
                data: $('#input-user-pwd').serialize(),
                type: "post",
                success: function(result) {
                    if (result.code == web_status.SUCCESS) {
                        layer.msg("请稍后……", {
                            icon: 1,
                            time: 500,
                            shade: [0.1, '#8F8F8F']
                        },function() {
                            location.reload();
                        });
                    } else {
                        alert(result.msg);
                    }
                }
            })
            $('#newPassword').modal('hide');
        }
    }

    $('#updateForm').on('show.bs.modal', function (event) {
        var Id='[[${user.userId}]]'
        var newName='[[${user.userName}]]'
        var newPhone='[[${user.phonenumber}]]'
        var newEmail='[[${user.email}]]'
        var newLoginName='[[${user.loginName}]]'
        var newProvince='[[${user.province}]]'
        $('#input-user-account').val(Id);
        $('#input-user-name').val(newName);
        $('#input-login-name').val(newLoginName);
        $('#input-user-phone').val(newPhone);
        $('#input-user-email').val(newEmail);
        var userSex='[[${user.sex}]]';
        if(userSex == '1'){
            //$('#input-user-sex').val('女');
            $('#choose-user-sex').val('1');
        }
        else if(userSex == '0'){
            //$('#input-user-sex').val('男');
            $('#choose-user-sex').val('0');
        }
        else {
            //$('#input-user-sex').val('未知');
            $('#choose-user-sex').val('2');
        }
        $('#input-user-province').val(newProvince);

    });

    $('#updateMoneyForm').on('show.bs.modal', function (event) {
        var Id='[[${user.userId}]]'
        //var newMoney='[[${user.money}]]'
        $('#input-money-user-account').val(Id);
        //$('#input-user-money').val(newMoney);
    });

    $(document).ready(function(){
        //console.log('111');
        var tableSex=document.getElementById("sex");
        var userSex='[[${user.sex}]]';
        if(userSex == '1'){
            $("#sex").html("女");
        }
        else if(userSex == '0'){
            $("#sex").html("男");
        }
        else {
            $("#sex").html("其他");
        }
    })

    // 导出数据
    function myExportExcel(formId) {
        var url=ctx+'system/user/profile/export';
        $.modal.confirm("确定导出个人信息吗？", function() {
            var dataParam=[
                {
                    "name": "deptId",
                    "value": ""
                },
                    {
                        "name": "parentId",
                        "value": ""
                    },
                    {
                        "name": "loginName",
                        "value": ""
                    },
                    {
                        "name": "phonenumber",
                        "value": ""
                    },
                    {
                        "name": "status",
                        "value": ""
                    },
                    {
                        "name": "params[beginTime]",
                        "value": ""
                    },
                    {
                        "name": "params[endTime]",
                        "value": ""
                    },
                    {
                        "name": "orderByColumn",
                        "value": "createTime"
                    },
                    {
                        "name": "isAsc",
                        "value": "desc"
                    }
                ];
            $.modal.loading("正在导出数据，请稍候...");
            $.post(url, dataParam, function(result) {
                if (result.code == web_status.SUCCESS) {
                    window.location.href = ctx + "common/download?fileName=" + encodeURI(result.msg) + "&delete=" + true;
                } else if (result.code == web_status.WARNING) {
                    $.modal.alertWarning(result.msg)
                } else {
                    $.modal.alertError(result.msg);
                }
                $.modal.closeLoading();
            });
        });
    }

    function printHtml() {
        $("#cz1").css("display","none");
        $("#cz2").css("display","none");
        $("#xg").css("display","none");
        window.print();
        $("#cz1").css("display","");
        $("#cz2").css("display","");
        $("#xg").css("display","");
    }


</script>
</body>
</html>